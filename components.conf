#
# Qubes+Salt Management Components
#

# =====================================
# Special Management Configuration Vars
# =====================================

# MGMT_SALT_DEVELOPER_MODE - Build developer related tools
# Set 1 to build developer tools or clear the value to ignore
# Default: novalue
MGMT_SALT_DEVELOPER_MODE ?= 

# MGMT_SALT_USER_FORMULAS - Custom mgmt-salt user formulas
# Add any extra user based mgmt-salt formulas to nclude in build
# Default: novalue
MGMT_SALT_USER_FORMULAS ?= 

# MGMT_SALT_ONLY - Only build mgmt-salt COMPONENTS
# Set 1 to only build salt-mgmt COMPONENTS or clear value to build all qubesi
# COMPONENTS
# Default: novalue
MGMT_SALT_ONLY ?=

# =====================
# Management Components
# =====================

# Required base modules and configurations
MGMT_SALT_COMPONENTS :=
MGMT_SALT_COMPONENTS += mgmt-salt
MGMT_SALT_COMPONENTS += mgmt-salt-base
MGMT_SALT_COMPONENTS += mgmt-salt-base-topd
MGMT_SALT_COMPONENTS += mgmt-salt-base-config
MGMT_SALT_COMPONENTS += mgmt-salt-base-overrides

#MGMT_SALT_COMPONENTS += mgmt-salt-demo

# General all purpose formulas
MGMT_SALT_COMPONENTS += mgmt-salt-all-salt
MGMT_SALT_COMPONENTS += mgmt-salt-all-yamlscript-renderer
MGMT_SALT_COMPONENTS += mgmt-salt-all-yamlscript-users
MGMT_SALT_COMPONENTS += mgmt-salt-all-gnupg
MGMT_SALT_COMPONENTS += mgmt-salt-all-vim
MGMT_SALT_COMPONENTS += mgmt-salt-all-privacy
MGMT_SALT_COMPONENTS += mgmt-salt-all-theme

# DomU specific formulas
MGMT_SALT_COMPONENTS += mgmt-salt-dom0-qvm
MGMT_SALT_COMPONENTS += mgmt-salt-dom0-update
MGMT_SALT_COMPONENTS += mgmt-salt-dom0-virtual-machines
MGMT_SALT_COMPONENTS += mgmt-salt-dom0-policy-qubesbuilder
MGMT_SALT_COMPONENTS += mgmt-salt-dom0-fix-permissions
MGMT_SALT_COMPONENTS += mgmt-salt-dom0-template-upgrade

# DomU specific formulas
MGMT_SALT_COMPONENTS += mgmt-salt-vm-python-pip

ifeq (1,$(MGMT_SALT_DEVELOPER_MODE))
  # Development tools and scripts
  MGMT_SALT_COMPONENTS += mgmt-salt-dev

  # Template to use to create new Qubes+Salt management packages
  MGMT_SALT_COMPONENTS += mgmt-salt-template

  # More recent build of salt
  MGMT_SALT_COMPONENTS += mgmt-salt-app-saltstack
  BRANCH_mgmt_salt_app_saltstack = 2015.8
endif

# Custom user formulas
MGMT_SALT_COMPONENTS += $(MGMT_SALT_USER_FORMULAS)

# Include any additional user components (MGMT_SALT_COMPONENTS_USER)
MGMT_SALT_COMPONENTS := $(MGMT_SALT_COMPONENTS) $(MGMT_SALT_COMPONENTS_USER)
export MGMT_SALT_COMPONENTS

[===========================================================================
[==- 'Insert mgmt COMPONENTiS/TEMPLATES after gui-agent-linux'
[==- 
[==- Ordering:
[==-   mgmt-salt-app-saltstack + mgmt-salt + remaninder or components
[===========================================================================
insert-at = \
	$(eval _pattern = $(1)) \
	$(eval _insertment = $(2)) \
	$(eval _text = $(3)) \
	$(strip $(patsubst $(_pattern), $(_pattern) $(_insertment), $(_text)))

reorder-mgmt-components = \
	$(eval _components = $(1)) \
	$(eval _mgmt_components = $(2)) \
	$(eval _filtered = $(filter-out mgmt-salt-app-saltstack mgmt-salt, $(_mgmt_components))) \
	$(call insert-at, \
	    gui-agent-linux, \
	    $(findstring mgmt-salt-app-saltstack, $(_mgmt_components)) mgmt-salt $(_filtered),\
	    $(_components))
	     
# If MGMT_SALT_ONLY is 1, then only mgmt-salt-* components are built
ifeq (1,$(MGMT_SALT_ONLY))
    COMPONENTS := \
	$(eval _filtered = $(filter-out mgmt-salt-app-saltstack mgmt-salt, $(MGMT_SALT_COMPONENTS))) \
    	$(findstring mgmt-salt-app-saltstack, $(MGMT_SALT_COMPONENTS)) mgmt-salt $(_filtered)
    ifeq ($(PACKAGE_SET),vm)
        TEMPLATE := $(COMPONENTS)
    endif

else
    COMPONENTS := $(call reorder-mgmt-components, $(COMPONENTS), $(MGMT_SALT_COMPONENTS))
    
    ifeq ($(PACKAGE_SET),vm)
        TEMPLATE := $(call reorder-mgmt-components, $(TEMPLATE), $(MGMT_SALT_COMPONENTS))
    endif
endif

# Update DISTS_VM with template flavors
DISTS_VM := $(TEMPLATE_FLAVOR_SALT)

about::
	@echo "mgmt-salt/components.conf"

# vim: filetype=make
