#
# Qubes+Salt Management Components
#

# =====================================
# Special Management Configuration Vars
# =====================================

# MGMT_SALT_DEVELOPER_MODE - Includes these additional components:
#     
#   mgmt-salt-dev:
#     Development tools and scripts package.
#     
#   mgmt-salt-template: 
#     Packaging template to used to create new Qubes+Salt management packages.
#
#   mgmt-salt-app-saltstack:
#     Builds salt packages (salt, salt-minion, etc).
#
# Set 1 to enable developer tools or clear the value to ignore
# Default: novalue (disabled)
MGMT_SALT_DEVELOPER_MODE ?= 0

# MGMT_SALT_ONLY - Build only mgmt-salt COMPONENTS
#  Only mgmt-salt components will bw built when issuing 'make qubes[-vm/dom0]
#  which is useful for developing.
#
# Set 1 to enable building only salt-mgmt COMPONENTS or clear value to build
# all qubes components including mgmt-salt.
# Default: novalue
MGMT_SALT_ONLY ?= 0

# MGMT_SALT_COMPONENTS_USER - Custom mgmt-salt user components
#   Add any extra user based mgmt-salt formula components to include in build.
# Default: novalue
MGMT_SALT_COMPONENTS_USER ?=

# =====================
# Management Components
# =====================

# Required base modules and configurations
MGMT_SALT_COMPONENTS ?=
MGMT_SALT_COMPONENTS += mgmt-salt
MGMT_SALT_COMPONENTS += mgmt-salt-base
MGMT_SALT_COMPONENTS += mgmt-salt-base-topd
MGMT_SALT_COMPONENTS += mgmt-salt-base-config
MGMT_SALT_COMPONENTS += mgmt-salt-base-overrides

# General all purpose formulas
#MGMT_SALT_COMPONENTS += mgmt-salt-all-salt
#MGMT_SALT_COMPONENTS += mgmt-salt-all-gnupg
#MGMT_SALT_COMPONENTS += mgmt-salt-all-vim
#MGMT_SALT_COMPONENTS += mgmt-salt-all-privacy
#MGMT_SALT_COMPONENTS += mgmt-salt-all-theme

# DomU specific formulas
MGMT_SALT_COMPONENTS += mgmt-salt-dom0-qvm
MGMT_SALT_COMPONENTS += mgmt-salt-dom0-update
MGMT_SALT_COMPONENTS += mgmt-salt-dom0-virtual-machines
#MGMT_SALT_COMPONENTS += mgmt-salt-dom0-policy-qubesbuilder
#MGMT_SALT_COMPONENTS += mgmt-salt-dom0-fix-permissions
#MGMT_SALT_COMPONENTS += mgmt-salt-dom0-template-upgrade

# DomU specific formulas
#MGMT_SALT_COMPONENTS += mgmt-salt-vm-python-pip

ifeq (1,$(MGMT_SALT_DEVELOPER_MODE))
  # Development tools and scripts
  MGMT_SALT_COMPONENTS += mgmt-salt-dev

  # Template to use to create new Qubes+Salt management packages
  MGMT_SALT_COMPONENTS += mgmt-salt-template

  # More recent build of salt
  MGMT_SALT_COMPONENTS += mgmt-salt-app-saltstack
  BRANCH_mgmt_salt_app_saltstack = 2015.8
endif

[===========================================================================
[==- 'Insert mgmt COMPONENTiS/TEMPLATES after gui-agent-linux'
[==- 
[==- Ordering:
[==-   mgmt-salt-app-saltstack + mgmt-salt + remaninder or components
[===========================================================================
insert-at = \
	$(eval _pattern = $(1)) \
	$(eval _insertment = $(2)) \
	$(eval _text = $(3)) \
	$(strip $(patsubst $(_pattern), $(_pattern) $(_insertment), $(_text)))

reorder-mgmt-components = \
	$(eval _components = $(1)) \
	$(eval _mgmt_components = $(2)) \
	$(eval _filtered = $(filter-out mgmt-salt-app-saltstack mgmt-salt, $(_mgmt_components))) \
	$(call insert-at, \
	    gui-agent-linux, \
	    $(findstring mgmt-salt-app-saltstack, $(_mgmt_components)) mgmt-salt $(_filtered),\
	    $(_components))
	     
uniq = \
	$(if $1,$(firstword $1) $(call uniq,$(filter-out $(firstword $1),$1)))

# Include any additional user components (MGMT_SALT_COMPONENTS_USER)
MGMT_SALT_COMPONENTS := $(call uniq, $(MGMT_SALT_COMPONENTS) $(MGMT_SALT_COMPONENTS_USER))
export MGMT_SALT_COMPONENTS

# If MGMT_SALT_ONLY is 1, then only mgmt-salt-* components are built
ifeq (1,$(MGMT_SALT_ONLY))
    COMPONENTS := \
	$(eval _filtered = $(filter-out mgmt-salt-app-saltstack mgmt-salt, $(MGMT_SALT_COMPONENTS))) \
    	$(findstring mgmt-salt-app-saltstack, $(MGMT_SALT_COMPONENTS)) mgmt-salt $(_filtered)
    ifeq ($(PACKAGE_SET),vm)
        TEMPLATE := $(COMPONENTS)
    endif

else
    COMPONENTS := $(call reorder-mgmt-components, $(COMPONENTS), $(MGMT_SALT_COMPONENTS))
    
    ifeq ($(PACKAGE_SET),vm)
        TEMPLATE := $(call reorder-mgmt-components, $(TEMPLATE), $(MGMT_SALT_COMPONENTS))
    endif
endif

# Update DISTS_VM with template flavors
DISTS_VM := $(TEMPLATE_FLAVOR_SALT)

about::
	@echo "mgmt-salt/components.conf"

# vim: filetype=make
