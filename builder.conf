###############################################################################
# To enable this flavor, add it to the builder.conf `BUILDER_PLUGINS`:
#   BUILDER_PLUGINS += app-salt-config
#
# There are 3 options to be able to apply this flavor to VM's
#
# 1) Use the `setup` program and select desired configurations when prompted
#
# 2) Add the `+app-salt-config` flavor to selected VM's like follows:
#    DISTS_VM += fc21+app-salt-config
#
# 3) Add the flavor globally to any template being built, by adding the
#    DIST match patterns to the main builder.conf.
#    TEMPLATE_FLAVOR_SALT = wheezy+minimal +standard whonix fc21
###############################################################################

# Uncomment to enable the `+app-salt-config` template flavor
# BUILDER_PLUGINS += app-salt-config

# TEMPLATE_FLAVOR_SALT - String separated list of whole or partial DIST_VMs
# and or flavors used to match which DIST_VMs will have flavor applied
#
# Example: 
#   TEMPLATE_FLAVOR_SALT = wheezy+minimal +standard whonix fc21
# Default:
#   no value

_flavor_name = +salt

_supported_vms ?= fc20 fc21 fc22 
_supported_vms += wheezy jessie
_supported_vms += trusty utopic vivid
_supported_vms += whonix-gateway whonix-workstation

# -----------------------------------------------------------------------------
# Called by setup since GET_VAR is defined, so enable all DISTS_VMS
# Add flavor to all supported DISTS_VMs
# -----------------------------------------------------------------------------
ifdef GET_VAR
    _filter = $(if $(findstring $(_flavor_name), $(_dist_vm)),,$(word 1,$(subst +, ,$(_dist_vm))))
    _dist = $(_dist_vm) $(_dist_vm)$(_flavor_name)
    _vm = $(if $(filter $(_filter), $(_supported_vms)), $(_dist))
    _template_flavor_salt := $(sort $(foreach _dist_vm, $(DISTS_VM), $(_vm)))

# -----------------------------------------------------------------------------
# Add flavor to all selected DISTS_VMs
# -----------------------------------------------------------------------------

#    # XXX: Unfinished; does not work...  Copy of alias code...
#    $(info $(BUILDER_PLUGINS))
#    $(info $(TEMPLATE_LABEL))
#    ifdef DISTS_DEFINED
#        _alias_name = $(word 1,$(subst :, ,$(_alias)))
#        _alias_flavor = $(word 2,$(subst :, ,$(_alias)))
#        _template_name = $(subst +,-,$(_alias_name))
#        _aliases = $(eval DISTS_VM := $(patsubst $(_alias_name), $(_alias_flavor), $(DISTS_VM))) \
#                  $(if $(filter $(_alias_flavor):$(_template_name), $(TEMPLATE_LABEL)),, \
#                      $(eval TEMPLATE_LABEL += $(_alias_flavor):$(_template_name)) \
#                  )
#        $(strip $(foreach _alias, $(TEMPLATE_ALIAS), $(_aliases)))
#    endif
#
#ifdef DISTS_DEFINED
#  _template_flavor = $(word 1,$(subst :, ,$(_LABEL)))
#  _template_name = $(word 2,$(subst :, ,$(_LABEL)))
#  _labels = $(filter $(filter $(_template_flavor), $(DISTS_VM)):$(_template_name), $(_LABEL))
#  TEMPLATE_LABEL := $(strip $(foreach _LABEL, $(TEMPLATE_LABEL), $(_labels)))
#endif

else ifdef TEMPLATE_FLAVOR_SALT
    #$(info $(TEMPLATE_LABEL))
    #$(info $(TEMPLATE_ALIAS))

    _dist_flavor = $(_dist_vm)$(_flavor_name)

    ##_label = $(findstring $(_dist_vm):, $(TEMPLATE_LABEL)) $(info $(_dist_vm))
    ##_mklabel = $(if $(_label), $(eval TEMPLATE_LABEL = $(patsubst $(_label), $(_dist_flavor):$(word 2,$(subst :, ,$(_label))),$(TEMPLATE_LABEL))),)

    #_label = $(findstring $(_dist_vm), $(TEMPLATE_ALIAS)) $(info $(_dist_vm)) $(info $(TEMPLATE_ALIAS))
    #_mklabel = $(if $(_label), $(eval TEMPLATE_ALIAS := $(patsubst $(_label), $(_dist_flavor):$(word 2,$(subst :, ,$(_label))),$(TEMPLATE_ALIAS))), )

    #_template_name = $(if $(_mklabel), $(_dist_flavor), $(_dist_flavor))
    #_filter = $(if $(findstring $(_flavor_name), $(_dist_vm)), $(_dist_vm), $(_template_name))

    _filter = $(if $(findstring $(_flavor_name), $(_dist_vm)), $(_dist_vm), $(_dist_vm)$(_flavor_name))
    _patsubst = $(eval DISTS_VM = $(patsubst $(_dist_vm), $(_filter), $(DISTS_VM)))
    _dist = $(if $(findstring $(_flavor), $(_dist_vm)), $(_patsubst),)
    _vm = $(foreach _flavor, $(TEMPLATE_FLAVOR_SALT), $(_dist))
    _template_flavor_salt := $(if $(foreach _dist_vm, $(DISTS_VM), $(_vm)), $(DISTS_VM), $(DISTS_VM))

# -----------------------------------------------------------------------------
# No flavors defined; Just use DISTS_VM as-is
# -----------------------------------------------------------------------------
else ifneq (,$(findstring $(_flavor_name), $(DISTS_VM)))
    _template_flavor_salt := $(DISTS_VM)

# -----------------------------------------------------------------------------
#  Do Not Enable
# -----------------------------------------------------------------------------
else
    _template_flavor_salt := 
endif

TEMPLATE_FLAVOR_SALT := $(_template_flavor_salt)
ifneq "$(TEMPLATE_FLAVOR_SALT)" ""

    # Define flavor directory location (here)
    TEMPLATE_FLAVOR_DIR += $(_flavor_name):$(SRC_DIR)/app-salt-config/template

    [==- 'app-salt' ============================================================
    [==-  defaults: [R2:2014.7.2, R3:2014.7.2]
    [==-
    [==- 'Insert COMPONENT/TEMPLATE after gui-agent-linux'
    [===========================================================================
    COMPONENTS := $(strip $(filter-out app-salt, $(COMPONENTS)))
    COMPONENTS := $(strip $(patsubst gui-agent-linux, gui-agent-linux app-salt, $(COMPONENTS)))
    TEMPLATE := $(strip $(patsubst gui-agent-linux, gui-agent-linux app-salt, $(TEMPLATE)))
    BRANCH_app_salt = 2014.7.2
  
    [==- 'app-salt-config' =====================================================
    [==-  defaults: [R2:develop-wip, R3:develop-wip]
    [==- 
    [==- 'Insert COMPONENT/TEMPLATE after app-salt'
    [===========================================================================
    COMPONENTS := $(strip $(filter-out app-salt-config, $(COMPONENTS)))
    COMPONENTS := $(strip $(patsubst app-salt, app-salt app-salt-config, $(COMPONENTS)))
    TEMPLATE := $(strip $(patsubst app-salt, app-salt app-salt-config, $(TEMPLATE)))
    BRANCH_app_salt_config = develop-wip

    # Update DISTS_VM with template flavors
    DISTS_VM := $(TEMPLATE_FLAVOR_SALT)

    # Automatically generate some sane labels
    #TEMPLATE_LABEL += fc20$(_flavor_name):fc20$(_flavor_label)
    #TEMPLATE_LABEL += fc21$(_flavor_name):fc21$(_flavor_label)
    #TEMPLATE_LABEL += fc22$(_flavor_name):fc22$(_flavor_label)
    #TEMPLATE_LABEL += wheezy$(_flavor_name):wheezy$(_flavor_label)
    #TEMPLATE_LABEL += jessie$(_flavor_name):jessie$(_flavor_label)
    #TEMPLATE_LABEL += trusty$(_flavor_name):trusty$(_flavor_label)
    #TEMPLATE_LABEL += utopic$(_flavor_name):utopic$(_flavor_label)
    #TEMPLATE_LABEL += vivid$(_flavor_name):vivid$(_flavor_label)
endif

about::
	@echo "app-salt-config/builder.conf"

# vim: filetype=make
