###############################################################################
# To enable this flavor, add it to the builder.conf `BUILDER_PLUGINS`:
#   BUILDER_PLUGINS += mgmt-salt
#
# There are 3 options to be able to apply this flavor to VM's
#
# 1) Use the `setup` program and select desired configurations when prompted
#
# 2) Add the `+salt` flavor to selected VM's like follows:
#    DISTS_VM += fc21+salt
#
# 3) Add the flavor globally to any template being built, by adding the
#    DIST match patterns to the main builder.conf.
#    TEMPLATE_FLAVOR_SALT = wheezy+minimal +standard whonix fc21
###############################################################################

# Uncomment to enable the `+mgmt-salt` template flavor
# BUILDER_PLUGINS += mgmt-salt

# TEMPLATE_FLAVOR_SALT - String separated list of whole or partial DIST_VMs
# and or flavors used to match which DIST_VMs will have flavor applied
#
# Example: 
#   TEMPLATE_FLAVOR_SALT = wheezy+minimal +standard whonix fc21
# Default:
#   no value

################################################################################
#                           S E L F   N A M E
################################################################################
_self := $(strip $(lastword 1,$(subst /, ,$(dir $(lastword $(MAKEFILE_LIST))))))

MGMT_SALT_FLAVOR_NAME = +salt

_supported_vms ?= fc20 fc21 fc22 fc23
_supported_vms += wheezy jessie stretch
_supported_vms += trusty utopic vivid
_supported_vms += whonix-gateway whonix-workstation

# -----------------------------------------------------------------------------
# Called by setup since GET_VAR is defined, so enable all DISTS_VMS
# Add flavor to all supported DISTS_VMs
# -----------------------------------------------------------------------------
ifdef GET_VAR
    _filter = $(if $(findstring $(MGMT_SALT_FLAVOR_NAME), $(_dist_vm)),,$(word 1,$(subst +, ,$(_dist_vm))))
    _dist = $(_dist_vm) $(_dist_vm)$(MGMT_SALT_FLAVOR_NAME)
    _vm = $(if $(filter $(_filter), $(_supported_vms)), $(_dist))
    _template_flavor_salt := $(sort $(foreach _dist_vm, $(DISTS_VM), $(_vm)))

else ifdef TEMPLATE_FLAVOR_SALT
    _dist_flavor = $(_dist_vm)$(MGMT_SALT_FLAVOR_NAME)

    _set_label = $(eval _label = $(filter $(_label_name):%, $(TEMPLATE_LABEL))) \
		 $(eval _label_left = $(word 1,$(subst :, ,$(_label)))) \
		 $(eval _label_right = $(word 2,$(subst :, ,$(_label)))) \
                 $(if $(_label_right), \
		 $(eval TEMPLATE_LABEL += $(_dist_flavor):$(_label_right)$(subst +,-,$(MGMT_SALT_FLAVOR_NAME))) \
                 ) 

    _set_alias = $(eval _alias = $(filter %:$(_dist_vm), $(TEMPLATE_ALIAS))) \
		 $(eval _alias_left = $(word 1,$(subst :, ,$(_alias)))) \
		 $(eval _label_name = $(or $(word 2,$(subst :, ,$(_alias)))), $(_dist_vm)) \
                 $(if $(_alias_left), \
    	 	     $(eval TEMPLATE_ALIAS += $(_alias_left):$(_dist_flavor)) \
                 ) \
	         $(_set_label) \
                 $(eval TEMPLATE_ALIAS := $(filter-out $(_alias), $(TEMPLATE_ALIAS))) 

    _add_flavor = $(_set_alias) $(_dist_flavor)
    _filter = $(if $(findstring $(MGMT_SALT_FLAVOR_NAME), $(_dist_vm)), $(_dist_vm), $(_add_flavor))
    _patsubst = $(eval DISTS_VM = $(patsubst $(_dist_vm), $(_filter), $(DISTS_VM)))
    _dist = $(if $(findstring $(_flavor), $(_dist_vm)), $(_patsubst),)

    _foreach_flavor = $(foreach _flavor, $(TEMPLATE_FLAVOR_SALT), $(_dist))
    _foreach_distvm = $(foreach _dist_vm, $(DISTS_VM), $(_foreach_flavor))
    _template_flavor_salt := $(_foreach_distvm) $(DISTS_VM)

# -----------------------------------------------------------------------------
# No flavors defined; Just use DISTS_VM as-is
# -----------------------------------------------------------------------------
else ifneq (,$(findstring $(MGMT_SALT_FLAVOR_NAME), $(DISTS_VM)))
    _template_flavor_salt := $(DISTS_VM)

# -----------------------------------------------------------------------------
#  Do Not Enable
# -----------------------------------------------------------------------------
else
    _template_flavor_salt := 
endif

ifeq ($(PKG_MANAGER),dpkg)
 DEPENDENCIES += python-yaml
else ifeq ($(PKG_MANAGER),rpm)
 DEPENDENCIES += PyYAML
endif

TEMPLATE_FLAVOR_SALT := $(_template_flavor_salt)
ifneq "$(TEMPLATE_FLAVOR_SALT)" ""
    # Define flavor directory location (here)
    TEMPLATE_FLAVOR_DIR += $(MGMT_SALT_FLAVOR_NAME):$(BUILDER_DIR)/$(SRC_DIR)/$(_self)/template

    -include $(BUILDER_DIR)/$(SRC_DIR)/$(_self)/components.conf
endif

about::
	@echo "mgmt-salt/builder.conf"

# vim: filetype=make
